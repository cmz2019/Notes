# 二、文本文件处理

## 1、读取文件内容

### more / less

作用：逐屏显示文件

**使用方法**：

+ `more shudu.c` 指定一个文件
+ `more *.[ch]` 指定多个文件
+ `ls -l | more` 指定0个文件
+ `less shudu.c` 

**more**

满屏后，显示--more--或--more--(15%)，可以使用 more 命令：

![image-20210621144815902](https://gitee.com/cmz2000/album/raw/master/image/image-20210621144815902.png)

**less**

less is more

+ 回退浏览的功能更强
+ 可直接使键盘的上下箭头键，或者 j, k，类似 vi 的光标定位键，以及 `PgUp`, `PgDn`, `Home`, `End`键
+ 有的 Unix 系统不提供 less 命令，但是可利用 more 命令的增强功能

### cat 与 od

作用：列出文件内容

`cat` concatenate：串结，文本格式打印 （选项- n：行号）
`od` octal dump：逐字节打印（`-c`, `-t c`, `-t x1`, `-t d1`, `-t u1` 选项）

**举例**

+ `cat tryl.c` 命令行参数 1 个
+ `cat –n shudu.c` 显示行号
+ `cat tryl.c tryx.c try.h` 命令行参数 3 个
+ `cat >try` 命令行参数 =0 个，从 stdin 获取数据，直到 `ctrl-d`
+ `cat tryl.c try2.c try.h > trysrc`
+ `cat makefile *.[ch] > src`
+ `od –t x1 x.dat` 以十六进制打印文件 x.dat 各字节
+ `od –t x1 x.dat | more` 以十六进制打印文件 x.dat 各字节
+ `od –c /bin/bash` 逐字符方式打印文件，遇到不可打印字符打印编码
+ `echo abcdABCD | od –t x1` 十六进制显示字符的 ASCII 码

### head 与 tail

作用：显示文件的头部或者尾部

默认只选择 10 行， `-n` 选项可以选择行数

**举例**

+ `head –n 15 ab.c` 显示文件 ab.c 中前15行
+ `head –n 23 a.c b.c c.c | more` 显示三个文件各自的前23行共显示69行
+ `tail –n 40 liu.mail`
+ `head –n -20 msg.c` 除去文件尾部20行其余均算“头”
+ `tail –n +20 msg.c` 除去文件头部20行其余均算作“尾”
+ `tail -f debug.txt` 实时打印文件尾部被追加的内容（选项 -f : forever）
  `netstat -s -p tcp | head`
  `ls -s | sort | head –n 20`

### tee

作用：三通。将从标准输入 stdin 得到的数据抄送到标准输出 stdout 显示，同时存入磁盘文件中。

**举例**

+ `./myap | tee myap.log`

### wc

作用：字计数（word count）

+ 列出文件中一共有多少行，有多少个单词，多少字符
+ 当指定的文件数大于1时，最后还列出一个合计
+ 常用选项 `-l`：只列出行计数

**举例**

+ `wc sum.c` （1个文件）
+ `wc x.c makefile stat.sh` （多个文件）
+ `wc -l *.c makefile start.sh` （只列出文件分别有多少行）
+ `ps -ef | wc -l` （0个）
+ `ps -ef | grep liang | wc -l` （0个）
+ `who | wc -l` （0个）

### sort

作用：对文件内容排序

+ `-n` 选项（Numberic）：对于数字按照算术值大小排序，而不是按照字符串比较规则，例如123与67
+ 可以选择行中某一部分作为排序关键字
+ 选择升序或降序
+ 字符串比较时对字母是否区分大小写
+ 内排序外排序等算法参数选择（当数据量较大时，性能调优）

**举例**

+ `sort telno > telno1`
+ `ls -s | sort | tail –10`
+ `ls -s | sort -n | tail –10`

### tr

作用：翻译字符

`tr string1 string2`：把标准输入拷贝到标准输出，string1 中出现的字符替换为 string2 中的对应字符

**举例**

+ `cat telnos | tr UVX uvx`
+ 例：用 [] 指定一个集合
  `cat report | tr '[a-z]' '[A-Z]'` 将小写字母改为大写字母
+ 例：用 \ 加三个八进制数字（类似 C 语言）表示一字符
  `cat file1 | tr % '\012'` 将%改为换行符，注意不要漏掉必需的单引号

### uniq

作用：筛选文件中的重复行（重复的行：紧邻的两行内容相同）

**用法**：

+ `uniq options`
+ `uniq options input-file`
+ `uniq options input-file output-file`

**选项**：

+ `-u`（uniqe）只保留没有重复的行

+ `-d` （duplicated）只保留有重复的行（但只打印一次）

  没有以上两个选项，则打印没有重复的行和有重复的行（但只打印一次)

+ `-c` （count）计数同样的行出现几次

## 2、正则表达式

### 功能

描述一个字符串模式

作用范围：

+ 字符串匹配操作和替换操作
+ 举例：Linux 中的 vi more grep yacc lex awk sed
+ 其他：Visual Studio，Word 等文本编辑器

**注意：**

正则表达式规则与文件名通配符规则不同

+ 正则表达式规则用于文本处理的场合
+ 文件名匹配规则用于文件处理的场合

### 单字符正则表达式

+ 长的正则表达式由单字符正则表达式构成的

+ 非特殊字符与其自身匹配

  如：正则表达式 a 与字符串 a 匹配，b 与 b，/ 与 /

#### 转义字符（\\）

`\. \* \$ \^ \[ \\`

正则表达式 \\* 与字符串 * 匹配，与字符串 \\* 不匹配

转义字符后除以上六种之外的不该出现其他字符，例如：不该出现 \u，这样的组合被视为undefined（未定义的），后出的软件有可能会有特殊的解释

#### 圆点（·）

匹配任意单字符

#### 星号（\*）

单字符正则表达式后跟 \*，匹配此单字符正则表达式的 0 次或任意多次出现

#### 锚点（\^与\$）

+ \$ 在尾部时有特殊意义，否则与其自身匹配
  + 例：123\$ 匹配文件中行尾的123，不在行尾的123字符不匹配
  + 例：​\$123 与字符串 \$123 匹配
  + 例：\.\$ 匹配行尾的任意字符
+ \^ 在首部时有特殊意义，否则与其自身匹配
  + 例：\^printf 匹配行首的 printf 字符串，不在行首的 printf 串不匹配
  + 例：Hel\^lo 与字符串 Hel\^lo 匹配
  + 例：在 vi 中使用：`10,50s/^    //g`，删除10-50行的每行行首的4个空格

#### 集合（\[与\]）

##### 基本用法

+ 在一对方括号之间的字符为集合的内容，如：单字符正则表达式 \[abcd\] 与 a 或 b, c, d 匹配
+ 圆点、星号、反斜线在方括号内时，代表它们自己，如：\[\\\*\.\] 可匹配 3 个单字符

##### 用减号 \- 定义一个区间

+ 如 \[a\-d\]  \[A\-Z\]  \[a\-zA\-Z0\-9\]
+ 集合含左右中括号两个字符
+ 减号在最后，则失去表示区间的意义
  + \[ad\-\] 只与3个字符匹配

##### 用 \^ 表示补集

+ \^ 在开头,则表示与集合内字符之外的任意字符匹配
  + `[^a-z]` 匹配任一非小写字母
  + `[^][]` 匹配任一非中括号字符
+ \^ 不在开头,则失去其表示补集的意义
  + `[a-z^]` 能匹配 27 个单字符

##### 举例

![image-20210621154836478](https://gitee.com/cmz2000/album/raw/master/image/image-20210621154836478.png)

![image-20210621154904429](https://gitee.com/cmz2000/album/raw/master/image/image-20210621154904429.png)

### 正则表达式扩展

+ 表示**分组**：圆括号 `()`

+ 表示逻辑运算：表示逻辑 “**或**” 的符号 `|`
  \(xy\)\* 可匹配空字符串, xy, xyxy, xyxyxy
  \(pink\|green\) 与 pink 或 green 匹配

+ 重复次数定义：与星号地位类似的 `+` 和 `?`，限定重复次数 `\{m,n\}`

  + \* 号表示它左边的单字符正则表达式的0次或多次重复
  + \+ 号表示1次或多次： `[0-9]+` 匹配长度至少为1数字串
  + ? 表示0次或一次： `a?` 匹配零个或一个a
  + 限定重复次数 `\{m,n\}`，例如： `[1-9][0-9]\{6,8\}` 匹配7-9位数字，首位非0

+ 命名的预定义集合

  `[[:xdigit:]]` 表示十六进制数字，`\d` 数字，`\D` 非数字

+ 比 \^ 和 \$ 更灵活的**锚点**定义

  例如：寻找一个数字串，但是要求这个数字串不许出现在“合计”两个字之后（“合计”可作为锚点）。

### 文本行筛选 grep

Global regular expression print

作用：在文件中查找字符串

语法：`grep 模式 文件名列表`

**举例**

+ `grep O_RDWR *.h`
+ `ps -ef | grep liang`
+ `ls -l / | grep '^d' | wc –l`
+ `grep '[0-9]*' shudu.c`
+ `grep '[0-9][0-9]*' shudu.c`

**grep选项**

+ `-n` 显示时每行前面显示行号
+ `-v` 显示所有不包含模式的行
+ `-i` 字母比较时忽略字母的大小写

**举例**

+ `grep -n main *.c`
  查找含有正则表达式 main 的行，并打印行号
  当文件数超过一个时，除了输出行号，还输出文件名
+ `grep -v '[Dd]isable' dev.stat>dev.active`
  取消文件中所有含有指定模式的行，生成新文件
+ `grep -i richard telnos`
  在文件中检索字符串 richard，不顾字母的大小写

### 流编辑 sed

**用法**

+ `sed '命令' 文件名列表`
+ `sed -e '命令1' -e '命令2' -e '命令3' 文件名列表`
+ `sed -f 命令文件 文件名列表`

**举例**

+ `tail -f pppd.log | sed 's/145\.37\.23\.26/桥西/g'`，把 IP 地址 145.37.23.26 替换为 “桥西”，注意不要忘记转义符号 `\`

+ `tail -f pppd.log | sed -f sed.cmd`

  其中 sed.cmd 文件内容为

  ```shell
  s/145\.37\.23\.26/桥西/g
  s/102\.157\.23\.109/柳荫街/g
  s/145\.37\.123\.57/大山子/g
  ```

+ `cat pm25.txt | sed 's/\[[^][]*]//g'`，删除所有被中括号包围的字段

**正则表达式替换**

![image-20210621162545167](https://gitee.com/cmz2000/album/raw/master/image/image-20210621162545167.png)

### 复杂筛选及加工 awk

作用：逐行扫描进行文本处理

**用法**

+ `awk '程序' 文件名列表`
+ `awk -f 程序文件名 文件名列表`

程序   条件 { 动作 }

一段程序：awk 自动对每行文本执行条件判断，满足条件执行动作（内置循环）

多段程序：允许多段程序，程序间用空格或分号隔开

**处理方式**

+ **（行）**输入文件的每行作为一个 **“记录”** ，变量 NR 就是行号

+ **（列）**每行用空格分隔开的部分，叫做记录的 **“域”**

  内置变量 \$1 是第1域内容，依次，​\$2 是第2域内容，…… 特别的，​\$0 指的是整个这一行的内容

+ awk 的处理为：**符合条件的行，执行相应的动作**

**awk描述的条件**

![image-20210621190055677](https://gitee.com/cmz2000/album/raw/master/image/image-20210621190055677.png)

**awk描述的动作**

![image-20210621190107147](https://gitee.com/cmz2000/album/raw/master/image/image-20210621190107147.png)

**举例**

![image-20210621190147914](https://gitee.com/cmz2000/album/raw/master/image/image-20210621190147914.png)

## 3、文件比对

### 文件内容比对

#### cmp

作用：两文件逐字节比较

**用法**：`cmp file1 file2`

**功能**

+ 逐字节比较两个文件是否**完全相同**
+ 两个文件完全相同时，不给出任何提示
+ 两个文件不同时，打印出第一个不同之处
+ 在 Windows 中有类似的命令 COMP

#### md5sum / sha1sum

+ 使用 MD5 算法（散列函数）根据文件内容生成16字节 hash 值，比较 hash 值是否相同，就可断定两文件内容是否完全相同
+ 使用 SHA-1 算法的命令名为 sha1sum（20字节 hash 值）
+ 常用于数据完整性（Data Integrity）验证和判断位于网络不同机器上的**两个文件内容是否相同**
+ 其他散列函数也可以用来完成这一任务：sha512sum

### 求文本文件版本间差异

#### diff

作用：求出两个文件的差别

**用法**

+ `diff file1 file2`
+ `diff -u file1 file2`

**功能**

+ 比较两个版本的文本文件，以寻找两者间差别
+ 输出格式 normal, unified **(-u)**
+ normal 格式：列出一个如何将 file1 转化为 file2 的指令
  + 这些指令有 **a** (Add), **c** (Change) 和 **d** (Delete)
  + 指令字母左边的行号是 file1 的行号，右面是 file2 的行号
  + 列出内容时，大于号后边的内容是需要在 file1 文件中增加的内容；小于号后边的内容是需从 file1 中删除的内容
+ normal 格式文件转化指令如下表

![image-20210621193011646](https://gitee.com/cmz2000/album/raw/master/image/image-20210621193011646.png)

**diff -u举例**

![image-20210621193413002](https://gitee.com/cmz2000/album/raw/master/image/image-20210621193413002.png)

## 4、vi 编辑器

### 编辑状态和光标移动

#### 用户的偏好设置

+ 用户 HOME 目录下的文件 \.exrc，记作 `$HOME/.exrc`（每用户一份，用户独立设置）

  ```shell
  set number		# 每行左边显示行号
  set tabstop=4	# 制表符位置为4格对齐
  ```

+ 用运行时检查偏好设置
  `:set`

#### vi 的两种工作状态

+ **命令状态：键盘输入解释为命令**
  + vi 一启动就进入命令方式，键盘输入解释为命令
  + 一般按键无回显
  + 以冒号可以引入行编辑的命令和查找命令
  + 编辑命令 i a 等，可以从命令状态转到文本状态
+ **文本状态**
  + 键盘输入解释为输入的文本
  + 可以输入多行，每输入完一行后按回车转入下一行
  + 正文输入时有回显
  + 输入完毕按键盘左上角的 Esc 键，返回到命令状态
+ **正文插入**
  + 命令 i 在当前字符前插入正文段，直至按 Esc 键 (insert)
  + 命令 a 在当前字符后插入正文段，直至按 Esc 键 (append)

<img src="https://gitee.com/cmz2000/album/raw/master/image/image-20210621195017049.png" alt="image-20210621195017049" style="zoom:50%;" />

#### 光标移动

##### 单字符移动

+ 单字符移动（四个字母键盘上相邻的按键）
  + **h** 光标左移一列
  + **j** 光标下移一行
  + **k** 光标上移一行
  + **L** 光标右移一列
  + 一般可以直接使用键盘上的方向键代替这四个字母
+ 命令前加一整数，表示这个命令连续执行多少遍
  + 5h 光标左移5列
  + 6j 光标下移6行
  + 23k 光标上移23行
  + 10L 光标右移10列

注意：在 vi 命令状态下的按键命令没有回显

##### 翻页

+ `Ctrl-b` 向后翻页（Backward）
+ `Ctrl-f` 向前翻页（Forward）
+ 一般可以用 PgDn 键代替 Ctrl-f，用 PgUp 键代替 Ctrl-b
+ 也可以使用下面的命令
  + 6Ctrl-f 向前翻6页
  + 15Ctrl-b 向后翻15页

##### 光标行内快速移动

+ **行尾行首**
  + 将光标移至当前行首 `^`
  + 将光标移至当前行尾 `$`
+ **移动一个单词**
  + 移到右一个单词 `w`
  + 移到左一个单词 `b`
  + 也可以使用 6w 5b 命令

##### 光标移动到指定行

+ 移到指定的行
  + `:476` 将光标定位于第476行
  + `:1` 将光标定位于第1行（文件首）
  + `:$` 将光标定位于文件尾
+ 在描述行号时可以使用
  + 圆点 `.` 代表当前行号
  + `$` 代表最后一行的行号
+ 括号配对 `%`
  + 把光标移到一个花括号（或圆括号，或方括号）上，按 `%` 键，则光标自动定位到与它配对的那一个括号  

### 查找、编辑及存盘

#### 删除和替换

+ 删除字符
  + 删除当前字符的命令 `x`
  + 命令 5x 删除从当前光标开始的5个字符  
+ 删除行
  + 删除当前行的命令 `dd`
  + 命令 3dd 删除从当前行开始的3行  
+ 替换光标处字符 `r`
  + `ra` 命令将当前光标处字符替换为 a
  + 将当前光标处开始的三个字符依次替换为 abc，则需要按命令 `rarbrc` 

#### 取消和重复

+ 取消上一次的编辑操作(undo) `u`
  + 如：误删了一段正文，用 u 命令可撤销删除
  + 如：把文件中的所有abc字符串替换成xyz字符串， 用 u 命令可撤销替换
+ 重复上一次的编辑操作 `.`
  + 按圆点键，可以重复上一次的编辑操作
  + 例如：按 3dd 命令删除了三行，然后按圆点键就再删除三行，接着连续按圆点键，每按一次删三行  

#### 文件操作命令

存盘退出：

+ `ZZ`
+ `:wq<CR>`

存盘不退出：`:w<CR>`

不存盘退出：`:q!<CR>`

读入文件 xyz.c 插入到当前行之下：`:r xyz.c<CR>`

写文件，把第50行至文件尾的内容写到文件 file1 中：

+ `:50,$w file1<CR>`
+ `:50,$w! file1<CR>`，强制覆盖

#### 剪贴板

删除，并拷贝到剪贴板：

+ `:10,50d<CR>`，删除第10-50行
+ `:1,.d<CR>`，删除文件首至当前行的部分
+ `:.,$d<CR>`，删除当前行到文件尾

不删除，拷贝到剪贴板（yank）：`:10,50y<CR>`

粘贴剪贴板信息（paste）：`p`

#### 块操作：复制与删除

复制：`:5,10co56<CR>`，复制第5-10行到第56行之下

移动：`:8,34m78<CR>`，移动第8-34行到第78行之下

#### 行合并、刷屏和状态显示

两行合并（Join） `J`，当前行下面的行合并到当前行

刷新屏幕显示（load） `Ctrl-l`

状态显示 `Ctrl-g`，在屏幕最下面一行列出正在编辑的文件的名字，总行数，当前行号，文件是否被修改过等信息

#### 模式查找与替换

用正则表达式来描述一个字符串模式

**查找命令**

+ 格式为 `/pattern`
+ 例如：`/[0-9][0-9*]`

**继续查找命令**

+ `n` 向下查找下一个next
+ `N` 向上查找下一个
+ 循环式搜索（向下搜索时遇到文件尾则回到文件头继续搜索）

**替换命令（substitution）**

+ 格式 `:n1,n2s/pattern/string/g`
+ 例如
  + `:1,50s/abc/xyz/`，不带 g 则每一行只替换第一个符合模式的
  + `:1,50s/abc/xyz/g`，带 g 会替换一行中所有符合模式的
  + `:50,75s/^/    /`，第50-75行右移4列
  + `:50,75s/^    //`，第50-75行左移4列
  + `:1,$s/ *$//`，消除尾部多余的空格
  + `:1,$s/a[i]/b[j]/g`，小心陷阱：不能把 a[i] 替换为 b[j]，要带转义符 `\`
  + `:1,$/a*b/x+y/g`，小心陷阱：不能把 a*b 替换为 x+y

**转义符**

+ 将 a[i]\*b[j] 替换为 x[k]\*y[n] 的命令：`:1,$s/a\[i]\*b\[j]/x[k]*y[n]/g`

+ 将 buf\.len/1000 替为 buffer\.size/1024 的命令：`:1,$s/buf\.len\/1000/buffer.size\/1024/g`，模式串和替换字符串中的斜线前加转义符\  以区别于替换命令格式中所必须的斜线

  `:1,$s:buf\.len/1000:buffer.size/1024:g`，s后面以冒号取代斜线，分界符就换为冒号，避免对斜线的转义，其他分隔符（如 `^`）同理，`:1,$s^http://www\.myvdo\.com/a/b/c/index\.html^https://www.xyvdo.com/index.html^g`

**假“死机”问题**

+ 现象

  vi 编辑结束后执行存盘操作，结果导致屏幕卡死，输入任何信息都不再有显示（死机，终端死机）

+ 原因

  vi 编辑结束后按下 `Ctrl-S`，因为 Windows 编辑器一般设置 `Ctrl-S` 热键的动作为 Save，但 Linux 却进入流量控制状态

+ 解决方法

  按下 `Ctrl-Q` 键后流量控制解除  

**意外中止问题**

+ 现象

  vi 编辑结束后存盘，程序意外中止，编辑成果丢失，文件内容未发生变化

+ 原因

  vi 存盘命令 `Shift-ZZ`，误操作为 `Ctrl-ZZ`，而 `Ctrl-Z` 按键导致当前运行进程被挂起（suspend），暂停运行（但进程尚在，处于 Stopped 状态）

+ 解决方法

  调用 bash 的作业管理机制，恢复运行被 Stopped 的进程

  + `jobs`，列表当前被 Stopped 的进程有哪些
  + `fg %1`，或 `%1`，将1号作业恢复到前台（foreground）运行



未完待续......