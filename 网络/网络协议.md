# HTTP协议

## 概述

HTTP 协议（超文本传输协议HyperText Transfer Protocol），它是基于TCP协议的应用层传输协议，简单来说就是客户端和服务端进行数据传输的一种规则。

> **注意**：客户端与服务器的角色不是固定的，一端充当客户端，也可能在某次请求中充当服务器。这取决于请求的发起端。HTTP协议属于应用层，建立在传输层协议TCP之上。客户端通过与服务器建立TCP连接，之后发送HTTP请求与接收HTTP响应都是通过访问Socket接口来调用TCP协议实现。

HTTP 是一种**无状态**协议，HTTP 协议本身不会对发送过的请求和相应的通信状态进行持久化处理。这样做的目的是为了保持HTTP协议的简单性，从而能够快速处理大量的事务，提高效率。

然而，在许多应用场景中，我们需要保持用户登录的状态或记录用户购物车中的商品。由于HTTP是无状态协议，所以必须引入一些技术来记录管理状态，例如Cookie。

通过使用网页浏览器、网络爬虫或者其它的工具，客户端发起一个HTTP请求到服务器上指定端口（默认端口为80）。我们称这个客户端为用户代理程序（user agent）。应答的服务器上存储着一些资源，比如HTML文件和图像。我们称这个应答服务器为源服务器（origin server）。在用户代理和源服务器中间可能存在多个“中间层”，比如代理服务器、网关或者隧道（tunnel）。

尽管TCP/IP协议是互联网上最流行的应用，HTTP协议中，并没有规定必须使用它或它支持的层。事实上，HTTP可以在任何互联网协议上，或其他网络上实现。HTTP假定其下层协议提供可靠的传输。因此，任何能够提供这种保证的协议都可以被其使用。因此也就是其在TCP/IP协议族使用TCP作为其传输层。

通常，由HTTP客户端发起一个请求，创建一个到服务器指定端口（默认是80端口）的TCP连接。HTTP服务器则在那个端口监听客户端的请求。一旦收到请求，服务器会向客户端返回一个状态，比如"HTTP/1.1 200 OK"，以及返回的内容，如请求的文件、错误消息、或者其它信息。

+ Https：安全的，学习视频链接如下

  [https://www.bilibili.com/video/BV1w4411m7GL](https://www.bilibili.com/video/BV1w4411m7GL)

## 请求响应模型

HTTP协议永远都是客户端发起请求，服务器回送响应。

![image-20210803205710864](https://strawberry-album.oss-cn-beijing.aliyuncs.com/image/image-20210803205710864.png)

这样就限制了使用HTTP协议，无法实现在客户端没有发起请求的时候，服务器将消息推送给客户端。

HTTP协议是一个无状态的协议，同一个客户端的这次请求和上次请求是没有对应关系。

## 工作原理

HTTP协议定义Web客户端如何从Web服务器请求Web页面，以及服务器如何把Web页面传送给客户端。HTTP协议采用了请求/响应模型。客户端向服务器发送一个请求报文，请求报文包含请求的方法、URL、协议版本、请求头部和请求数据。服务器以一个状态行作为响应，响应的内容包括协议的版本、成功或者错误代码、服务器信息、响应头部和响应数据。

以下是 HTTP 请求/响应的步骤：

1. 客户端连接到Web服务器

   一个HTTP客户端，通常是浏览器，与Web服务器的HTTP端口（默认为80）建立一个TCP套接字连接。例如，[http://www.baidu.com](http://www.baidu.com/)。

2. 发送HTTP请求

   通过TCP套接字，客户端向Web服务器发送一个文本的请求报文，一个请求报文由请求行、请求头部、空行和请求数据 4 部分组成。

3. 服务器接受请求并返回HTTP响应

   Web服务器解析请求，定位请求资源。服务器将资源副本写到TCP套接字，由客户端读取。一个响应由状态行、响应头部、空行和响应数据 4 部分组成。

4. 释放连接TCP连接

   若 header 的 connection 字段值为 close，则在完成单次请求-响应后，服务器主动关闭TCP连接，客户端被动关闭连接，释放TCP连接；若 connection 字段值为 keepalive，则该连接会保持一段时间，在该时间内可以继续通过相同的TCP连接接收/响应请求。

5. 客户端浏览器解析HTML内容

   客户端浏览器首先解析状态行，查看表明请求是否成功的状态代码。然后解析每一个响应头，响应头告知以下为若干字节的HTML文档和文档的字符集。客户端浏览器读取响应数据HTML，根据HTML的语法对其进行格式化，并在浏览器窗口中显示。

例如：在浏览器地址栏键入URL，按下回车之后会经历以下流程：

1. 浏览器向 DNS 服务器请求解析该 URL 中的域名所对应的 IP 地址；
2. 解析出 IP 地址后，根据该 IP 地址和默认端口 80，和服务器建立TCP连接；
3. 浏览器发出读取文件（URL 中域名后面部分对应的文件）的 HTTP 请求，该请求报文作为 TCP 三次握手的第三个报文的数据发送给服务器；
4. 服务器对浏览器请求作出响应，并把对应的 html 资源发送给浏览器；
5. 释放 TCP 连接；
6. 浏览器将该 html 资源渲染并显示内容。

### 基于请求-响应的模式

![image-20210803223223982](https://strawberry-album.oss-cn-beijing.aliyuncs.com/image/image-20210803223223982.png)

HTTP协议规定，请求从客户端发出，最后服务器端响应该请求并返回。换句话说，肯定是先从客户端开始建立通信的，服务器端在没有接收到请求之前不会发送响应。

### 无状态保存

![image-20210803223618001](https://strawberry-album.oss-cn-beijing.aliyuncs.com/image/image-20210803223618001.png)

HTTP是一种不保存状态，即无状态（stateless）协议。HTTP协议自身不对请求和响应之间的通信状态进行保存。也就是说在HTTP这个 级别，协议对于发送过的请求或响应都不做持久化处理。

使用HTTP协议，每当有新的请求发送时，就会有对应的新响应产生，协议本身并不保留之前一切的请求或响应报文的信息。这是为了更快地处理大量事务，确保协议的可伸缩性，而特意把HTTP协议设计成如此简单的。可是，随着Web的不断发展，因无状态而导致业务处理变得棘手的情况增多了。比如，用户登录到一家购物网站，即使他跳转到该站的其他页面，也需要能继续保持登录状态。针对这个实例，网站为了能够掌握是谁送出的请求，需要保存用户的状态。HTTP/1.1虽然是无状态协议，但为了实现期望的保持状态功能，引入了Cookie技术。有了Cookie再用HTTP协议通信，就可以管理状态了。有关Cookie的详细内容稍后讲解。

### 无连接

无连接的含义是限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间，并且可以提高并发性能。

#### 长短连接

+ 在HTTP/1.0版本的时候，客户端与服务器完成一个请求/响应之后，会将之前建立的**TCP连接断开**，下次请求的时候又要重新建立TCP连接，这也被称为**短连接**
+ 在HTTP/1.1版本中：在客户端与服务器完成一次请求/响应之后，允许不断开TCP连接，这意味着下次请求就直接使用这个TCP连接而不再需要重新握手建立新连接，这也被称为**长连接**

**注意：长连接是指一次TCP连接允许多次HTTP会话，HTTP永远都是一次请求/响应，会话结束，HTTP本身不存在长连接之说**。

早在1999年HTTP1.1就推广普及，所以现在浏览器在请求时请求头中都会携带一个参数：Connection:keep-alive，这表示浏览器要求与服务器建立长连接，而服务器也可以设置是否愿意建立长连接。

#### 长短连接优缺点

对于服务器来说建立长连接有优点也有缺点：

+ 优点：当网站中有大量静态资源（图片、css、js等）就可以开启长连接，这也几张图片就可以通过一次TCP连接发送。
+ 缺点：当客户端请求一次之后不再请求，而服务器却开着长连接，资源被占用着，这是严重浪费资源。

所以是否开启长连接、长连接时间都需要根据网站自身来合理设置。

## 客户端请求

客户端与服务器连接上了之后，客户端就可以开始向服务器请求资源，就可以开始发送HTTP请求了。

### HTTP请求报文结构

<img src="https://strawberry-album.oss-cn-beijing.aliyuncs.com/image/image-20210804001040198.png" alt="image-20210804001040198" style="zoom:67%;" />

![image-20210804010547482](https://strawberry-album.oss-cn-beijing.aliyuncs.com/image/image-20210804010547482.png)

#### HTTP请求行

请求行由请求 `Method`，`URL` 字段和 `HTTP Version` 三部分构成，总的来说请求行就是定义了本次请求的请求方式、请求的地址，以及所遵循的HTTP协议版本

例如：

```http
GET /example.html HTTP/1.1 (CRLF)
```

其中，HTTP/1.1协议中共定义了八种请求方法（也叫“动作”）来以不同方式操作指定的资源：

+ `GET`

请求**获取** Request-URI 所标识的资源。使用GET方法应该只用在读取数据，而不应当被用于产生“副作用”的操作中，例如在Web Application中。其中一个原因是GET可能会被网络蜘蛛等随意访问。

+ `HEAD`

请求获取由 Request-URI 所标识的资源的**响应消息报头**。与GET方法一样，都是向服务器发出指定资源的请求。只不过服务器将不传回资源的本文部分。它的好处在于，使用这个方法可以在不必传输全部内容的情况下，就可以获取其中“关于该资源的信息”（元信息或称元数据）。

+ `POST`

在 Request-URI 所标识的资源后**增加**新的数据。向指定资源提交数据，请求服务器进行处理（例如提交表单或者上传文件）。数据被包含在请求本文中。这个请求可能会创建新的资源或修改现有资源，或二者皆有。

> Get 和 Post 对比：
>
> + Get：请求能够携带的参数比较少，大小有限制，会在浏览器的URL地址栏显示数据内容，不安全，但高效
> + Post：请求能够携带的参数没有限制，大小没有限制，不会在浏览器的URL地址栏显示数据内容，安全，但不高效

+ `PUT`

请求服务器**存储或修改**一个资源，并用 Request-URI 作为其标识。

+ `DELETE`

请求服务器删除 Request-URI 所标识的资源。

+ `TRACE`

请求服务器回送收到的请求信息，主要用于**测试或诊断**。

+ `OPTIONS`

请求查询服务器的性能，或者查询与资源相关的选项和需求。这个方法可使服务器传回该资源所支持的所有HTTP请求方法。用 \'\*\' 来代替资源名称，向Web服务器发送OPTIONS请求，可以测试服务器功能是否正常运作。

+ `CONNECT`

保留将来使用。HTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器。通常用于SSL加密服务器的链接（经由非加密的HTTP代理服务器）。

#### HTTP请求头

消息报头由一系列的键值对组成，允许客户端向服务器端发送一些附加信息或者客户端自身的信息，主要包括：

| Header          | 解释                                                         | 示例                                                |
| --------------- | ------------------------------------------------------------ | --------------------------------------------------- |
| Authority       | 请求的域名（对方的服务器地址）                               | `Authority: www.google.com.hk`                      |
| Method          | 请求方法                                                     | `Method: GET`                                       |
| Path            | 请求路径，也就是 https://ww.google.com.hk/ 后面的内容        | `Path: /?gws_rd=ssl`                                |
| Accept          | 指定客户端能够接收的内容类型                                 | `Accept: text/plain,text/html`                      |
| Referer         | 允许客户端指定请求uri的源资源地址                            | 略，见实例                                          |
| Accept-Charset  | 客户端可以接收的字符编码集                                   | `Accept-Charset: iso-8895-5,utf-8`                  |
| Accept-Encoding | 可支持的内容压缩类型                                         | `Accept-Encoding: gzip,deflate`                     |
| Accept-Language | 可接受的语言                                                 | `Accept-Language: en,zh`                            |
| Accept-Ranges   | 可以请求网页实体的一个或者多个子范围字段                     | `Accept-Ranges: bytes`                              |
| Authorization   | HTTP授权的授权证书类型                                       | `Authorization: Basic QWxhZGRpbjpvcGVulHNIc2FtZQ==` |
| Cache-Control   | 指定请求和响应遵循的缓存机制                                 | `Cache-Control: no-cache`                           |
| Connection      | 表示是否需要持久连接（HTTP 1.1默认进行持久连接）             | `Connection: close`                                 |
| Cookie          | HTTP请求发送时，会把保存在该请求域名下的所有cookie值一起发送给web服务器 | `Cookie: $Version=1; Skin=new;`                     |
| Content-Length  | 请求的内容长度                                               | `Content-Length: 348`                               |
| User-Agent      | 包含发出请求的用户信息，表明了浏览器的身份：是什么内核，运行在什么系统上 | 略                                                  |

#### HTTP请求正文

只有在发送 `POST`请求时才会有请求正文，`GET` 方法并没有请求正文。

### HTTP请求实例

![image-20210804010939177](https://strawberry-album.oss-cn-beijing.aliyuncs.com/image/image-20210804010939177.png)

## 服务端响应

服务器在收到客户端请求处理完需要响应并返回给客户端，而HTTP响应报文结构与请求结构体一致。

### HTTP响应报文结构

<img src="https://strawberry-album.oss-cn-beijing.aliyuncs.com/image/image-20210804011106000.png" alt="image-20210804011106000" style="zoom:67%;" />

![image-20210804011152109](https://strawberry-album.oss-cn-beijing.aliyuncs.com/image/image-20210804011152109.png)

#### HTTP响应状态行

状态行也由三部分组成，包括HTTP协议的版本，状态码，以及对状态码的文本描述。

例如：

```http
HTTP/1.1 200 OK （CRLF）
```

#### 响应头

#### 响应正文

### HTTP响应实例

![image-20210804011508535](https://strawberry-album.oss-cn-beijing.aliyuncs.com/image/image-20210804011508535.png)

### HTTP响应状态码

状态代码有三位数字组成，第一个数字定义了响应的**类别**，且有以下五种可能取值：

![image-20210804011551563](https://strawberry-album.oss-cn-beijing.aliyuncs.com/image/image-20210804011551563.png)

常见状态代码、状态描述说明： 

`200`：**OK** - 客户端请求成功

`400`：**Bad Request** - 客户端请求有语法错误，不能被服务器所理解

`401`：**Unauthorized** - 请求未经授权，这个状态代码必须和 `WWW-Authenticate` 报头域一起使用

`403`：**Forbidden** - 服务器收到请求，但是拒绝提供服务

`404`：**Not Found** - 请求资源不存在，eg：输入了错误的URL

`500`：**Internal Server Error** - 服务器发生不可预期的错误

`503`：**Server Unavailable** - 服务器当前不能处理客户端的请求，一段时间后，可能恢复正常

# WebSocket

+ 连接时基于Http，是Http的升级
+ 支持server主动向client发送消息
+ ping/pong 保持连接

# Socket

[https://www.jianshu.com/p/066d99da7cbd](https://www.jianshu.com/p/066d99da7cbd)

